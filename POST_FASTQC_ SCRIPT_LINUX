#!/bin/bash

ref="/mnt/Prithu/001_Quelcus/001_Quelcus/001_reference/Qgl_r1.0.fa"
rawdir="/mnt/Prithu/001_Quelcus/001_Quelcus/001_raw_data"
cleandir="/mnt/Prithu/001_Quelcus/001_Quelcus/001_fastp_cut_output"
bamdir="/mnt/Prithu/001_Quelcus/nov2025/quercus_bamdir"
samdir="/mnt/Prithu/001_Quelcus/nov2025/quercus_samdir"
vcfdir="/mnt/Prithu/001_Quelcus/nov2025/quercus_vcfdir"

echo "STEP 1: ALIGN READS WITH BWA MEM"
for sample in "$cleandir"/*; do
    if [ -d "$sample" ]; then
        sampleid=$(basename "$sample")
        fwd="${sample}/${sampleid}_1.clean.fastq.gz"
        rvs="${sample}/${sampleid}_2.clean.fastq.gz"

        mkdir -p "${bamdir}/${sampleid}"

        echo "Aligning sample: ${sampleid}"
        bwa mem -t 8 \
            -R "@RG\tID:D00689\tSM:${sampleid}\tLB:${sampleid}lib\tPL:ILLUMINA" \
            "$ref" "$fwd" "$rvs" | \
            samtools view -Sb - > "${bamdir}/${sampleid}/${sampleid}.bam"
    fi
done

echo "STEP 2: SORT BAM FILES"
for sample in "$bamdir"/*; do
    if [ -d "$sample" ]; then
        sampleid=$(basename "$sample")
        echo "Sorting BAM for: ${sampleid}"
        samtools sort "${sample}/${sampleid}.bam" \
            -o "${sample}/${sampleid}_sort.bam"
    fi
done

echo "STEP 3: MARK DUPLICATES"
for sample in "$bamdir"/*; do
    if [ -d "$sample" ]; then
        sampleid=$(basename "$sample")
        echo "Marking duplicates for: ${sampleid}"
        picard MarkDuplicates \
            I="${sample}/${sampleid}_sort.bam" \
            O="${sample}/${sampleid}_sort_mark.bam" \
            M="${sample}/${sampleid}_metrics.txt"
    fi
done

echo "STEP 4: INDEX BAM"
for sample in "$bamdir"/*; do
    if [ -d "$sample" ]; then
        sampleid=$(basename "$sample")
        echo "Indexing BAM for: ${sampleid}"
        samtools index "${sample}/${sampleid}_sort.bam"
    fi
done


echo "STEP 5: GENOTYPING"
# Build BAM list
bam_list="${bamdir}/mpile_list.txt"
> "$bam_list"
for sample in "$bamdir"/*; do
    if [ -d "$sample" ]; then
        sampleid=$(basename "$sample")
        bam_path="${sample}/${sampleid}_sort.bam"
        if [ -f "$bam_path" ]; then
            echo "$bam_path" >> "$bam_list"
        else
            echo "BAM not found for ${sampleid}: ${bam_path}" >&2
        fi
    fi
done

cd "${bamdir}" || exit 1
OutTag="Qgl_r1.0_wholegenome"

bcftools mpileup -Ou \
    -f "$ref" \
    -b "$bam_list" | \
bcftools call -mv -Oz \
    -o "${vcfdir}/${OutTag}.var_filt.vcf.gz"

bcftools index "${vcfdir}/${OutTag}.var_filt.vcf.gz"


# GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK
# GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK
# GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK GATK
#!/bin/bash

ref="/mnt/sdb2/Prithu/001_Quelcus/001_Quelcus/001_reference/Qgl_r1.0.fa"
bamdir="/mnt/sdb2/Prithu/001_Quelcus/nov2025/quercus_bamdir"
rawdir="/mnt/sdb2/Prithu/001_Quelcus/001_Quelcus/001_raw_data"
cleandir="/mnt/sdb2/Prithu/001_Quelcus/001_Quelcus/001_fastp_cut_output"
samdir="/mnt/sdb2/Prithu/001_Quelcus/nov2025/quercus_samdir"
vcfdir="/mnt/sdb2/Prithu/001_Quelcus/nov2025/quercus_vcfdir"
#  GATK OUTPUT DIRECTORIES
BASE_OUTPUT_DIR="/mnt/sdb2/Prithu/001_Quelcus/nov2025"
gatkdir="${BASE_OUTPUT_DIR}/gatkdir"
gvcfdir="${gatkdir}/gvcf_intermediate"
genomicsdb_dir="${gatkdir}/genomicsdb_cohort"
OutTag="Qgl_r1.0_wholegenome"
final_vcf="${gatkdir}/${OutTag}.joint_genotype.vcf.gz"

# --- SETUP ---
echo "STEP 5: GENOTYPING (GATK Best Practices Workflow)"

if [ ! -f "$ref" ] || [ ! -d "$bamdir" ]; then
    echo "ERROR: Please update 'ref' and 'bamdir' variables in the script with valid paths." >&2
    exit 1
fi

mkdir -p "$gatkdir"
mkdir -p "$gvcfdir"


# NEW STEP: REFERENCE PREPROCESSING
echo "STEP 5.0: PREPARING REFERENCE GENOME INDEXES"

# 1. Create FASTA index (.fai)
if [ ! -f "$ref.fai" ]; then
    echo "Creating FASTA index (.fai)..."
    samtools faidx "$ref"
else
    echo "FASTA index (.fai) already exists."
fi

# 2. Create Sequence Dictionary
dict_file="${ref%.*}.dict"
if [ ! -f "$dict_file" ]; then
    echo "Creating Sequence Dictionary (.dict)..."
    gatk CreateSequenceDictionary -R "$ref" -O "$dict_file"
else
    echo "Sequence Dictionary (.dict) already exists."
fi

echo "Reference preparation complete."
# --------------------------------------------# 
# --- STAGE 1: PER-SAMPLE VARIANT CALLING --- #
echo "STAGE 1/3: Running HaplotypeCaller in GVCF mode on each sample..."

gvcf_list="${gatkdir}/gvcf_list.txt"
> "$gvcf_list"

for sample in "$bamdir"/*; do
    if [ -d "$sample" ]; then
        sampleid=$(basename "$sample")
        bam_path="${sample}/${sampleid}_sort.bam"
        gvcf_output="${gvcfdir}/${sampleid}.g.vcf.gz"

        if [ -f "$bam_path" ]; then
            echo "Processing sample: ${sampleid}"

            gatk HaplotypeCaller \
                -R "$ref" \
                -I "$bam_path" \
                -O "$gvcf_output" \
                -ERC GVCF \
                --native-pair-hmm-threads 8

            if [ $? -eq 0 ]; then
                echo "-V ${gvcf_output}" >> "$gvcf_list"
            else
                echo "ERROR: HaplotypeCaller failed for sample ${sampleid}. Skipping Genotyping steps." >&2
                exit 1
            fi
        else
            echo "BAM not found for ${sampleid}: ${bam_path}" >&2
        fi
    fi
done

if [ ! -s "$gvcf_list" ]; then
    echo "ERROR: No GVCF files were successfully generated. Cannot proceed to joint calling." >&2
    exit 1
fi

#  (GenomicsDBImport)
echo "STAGE 2/3: Importing GVCFs into GenomicsDB..."
mkdir -p "$genomicsdb_dir"

gatk GenomicsDBImport \
    -V "$gvcf_list" \
    --genomicsdb-workspace-path "$genomicsdb_dir" \
    -R "$ref"

#  JOINT GENOTYPING GenotypeGVCFs
echo "STAGE 3/3: Performing joint genotyping on the cohort..."

#  GenomicsDB
gatk GenotypeGVCFs \
    -R "$ref" \
    -V "gendb://${genomicsdb_dir}" \
    -O "$final_vcf"

#  INDEXING
echo "Indexing final VCF..."
gatk IndexFeatureFile -I "$final_vcf"

echo "Genotyping pipeline complete. Final VCF: ${final_vcf}"
